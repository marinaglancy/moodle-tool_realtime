define("tool_realtime/test_settings",["exports","core/ajax","core/pubsub","tool_realtime/events","tool_realtime/api"],(function(_exports,_ajax,PubSub,_events,_api){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * JavaScript for the test settings page
   *
   * @module     tool_realtime/test_settings
   * @copyright  Marina Glancy
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),PubSub=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(PubSub),_events=_interopRequireDefault(_events);const SELECTORS_root="#tool-realtime-test-settings",SELECTORS_stat=name=>'[data-stat="'.concat(name,'"]'),SELECTORS_action=name=>'[data-action="'.concat(name,'"]'),SELECTORS_field=name=>'[data-field="'.concat(name,'"]'),SELECTORS_region=name=>'[data-region="'.concat(name,'"]');let receiveStats=null,pushStats=null,receiveTimeoutId=null;const generateBurstId=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,8),resetReceiveStats=function(){let burstid=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";clearReceiveTimeout(),receiveStats={count:0,expected:0,totalLatency:0,min:1/0,max:-1/0,errors:0,errorMessages:[],seqReceived:new Set,burstid:burstid}},resetPushStats=()=>{pushStats={count:0,expected:0,totalRtt:0,min:1/0,max:-1/0,errors:0,errorMessages:[]}},getRoot=()=>document.querySelector(SELECTORS_root),updateStat=(name,value)=>{const el=getRoot().querySelector(SELECTORS_stat(name));el&&(el.textContent=value)},showRegion=name=>{const el=getRoot().querySelector(SELECTORS_region(name));el&&el.classList.remove("d-none")},hideRegion=name=>{const el=getRoot().querySelector(SELECTORS_region(name));el&&el.classList.add("d-none")},showResetButton=section=>{const el=getRoot().querySelector(SELECTORS_action(section+"-reset"));el&&el.classList.remove("d-none")},getFieldValue=function(name){let defaultValue=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const el=getRoot().querySelector(SELECTORS_field(name));if(!el)return defaultValue;const val=parseInt(el.value,10);return isNaN(val)?defaultValue:val},formatMs=ms=>Math.round(ms)+" ms",extractErrorMessage=err=>err?"string"==typeof err?err:err.message?err.message:err.error?err.error+(err.debuginfo?" ("+err.debuginfo+")":""):String(err):"Unknown error",addReceiveError=message=>{receiveStats||resetReceiveStats(),receiveStats.errors++,receiveStats.errorMessages.push(message)},clearReceiveTimeout=()=>{null!==receiveTimeoutId&&(clearTimeout(receiveTimeoutId),receiveTimeoutId=null)},resetReceiveTimeout=()=>{clearReceiveTimeout(),receiveStats&&receiveStats.expected>0&&receiveStats.count<receiveStats.expected&&(receiveTimeoutId=setTimeout((()=>{const missing=receiveStats.expected-receiveStats.count;addReceiveError("Timeout: "+missing+" event(s) not received within 90s"),updateStat("receive-status","Timeout ("+receiveStats.count+" of "+receiveStats.expected+" received)"),updateReceiveDisplay()}),9e4))},updateReceiveDisplay=()=>{showRegion("receive-results"),showResetButton("receive");const countText=receiveStats.expected>0?receiveStats.count+" / "+receiveStats.expected:String(receiveStats.count);if(updateStat("receive-count",countText),updateStat("receive-errors",String(receiveStats.errors)),receiveStats.count>0){const avg=receiveStats.totalLatency/receiveStats.count;updateStat("receive-avg",formatMs(avg)),updateStat("receive-minmax",formatMs(receiveStats.min)+" / "+formatMs(receiveStats.max))}if(receiveStats.errors>0){showRegion("receive-error-details");const el=getRoot().querySelector(SELECTORS_region("receive-error-messages"));el&&(el.textContent=receiveStats.errorMessages.join("\n"))}receiveStats.expected>0&&receiveStats.count>=receiveStats.expected&&(clearReceiveTimeout(),updateStat("receive-status",receiveStats.errors>0?"Complete (with errors)":"Complete"))},updatePushDisplay=()=>{showRegion("push-results"),showResetButton("push");const countText=pushStats.expected>0?pushStats.count+" / "+pushStats.expected:String(pushStats.count);if(updateStat("push-count",countText),updateStat("push-errors",String(pushStats.errors)),pushStats.count>0){const avg=pushStats.totalRtt/pushStats.count;updateStat("push-avg",formatMs(avg)),updateStat("push-minmax",formatMs(pushStats.min)+" / "+formatMs(pushStats.max))}if(pushStats.errors>0){showRegion("push-error-details");const el=getRoot().querySelector(SELECTORS_region("push-error-messages"));el&&(el.textContent=pushStats.errorMessages.join("\n"))}pushStats.expected>0&&pushStats.count+pushStats.errors>=pushStats.expected&&updateStat("push-status",pushStats.errors>0?"Complete (with errors)":"Complete")},onEventReceived=data=>{if("tool_realtime"!==data.component||"test"!==data.area)return;if(!receiveStats)return;const payload=data.payload||{};if(receiveStats.burstid&&payload.burstid!==receiveStats.burstid)return;const now=Date.now(),senttime=parseInt(payload.senttime,10),seq=parseInt(payload.seq,10),total=parseInt(payload.total,10);if(total>0&&(receiveStats.expected=total),!senttime||isNaN(senttime)||senttime<=0)return addReceiveError("Event received with missing or invalid senttime: "+JSON.stringify(payload)),void updateReceiveDisplay();receiveStats.expected>1&&!isNaN(seq)&&(receiveStats.seqReceived.has(seq)&&addReceiveError("Duplicate event received for seq="+seq),receiveStats.seqReceived.add(seq));const latency=now-senttime;receiveStats.count++,receiveStats.totalLatency+=latency,receiveStats.min=Math.min(receiveStats.min,latency),receiveStats.max=Math.max(receiveStats.max,latency),updateStat("receive-status","Receiving..."),resetReceiveTimeout(),updateReceiveDisplay()},sendTestEvents=(count,useadhoc,burstid,delay)=>_ajax.default.call([{methodname:"tool_realtime_send_test_events",args:{count:count,useadhoc:useadhoc,burstid:burstid,delay:delay}}])[0],handleReceiveSingle=async()=>{const burstid=generateBurstId();resetReceiveStats(burstid),updateStat("receive-status","Sending..."),showRegion("receive-results");try{await sendTestEvents(1,!1,burstid,0)}catch(err){addReceiveError("Failed to send test event: "+extractErrorMessage(err)),updateStat("receive-status","Error"),updateReceiveDisplay()}},handleReceiveBurst=async()=>{const count=getFieldValue("receive-burst-count"),delay=getFieldValue("receive-burst-delay",0),burstid=generateBurstId();resetReceiveStats(burstid),receiveStats.expected=count,updateStat("receive-status","Queued, waiting for cron..."),updateStat("receive-count","0 / "+count),updateStat("receive-avg","—"),updateStat("receive-minmax","—"),updateStat("receive-errors","0"),hideRegion("receive-error-details"),showRegion("receive-results"),showResetButton("receive");try{await sendTestEvents(count,!0,burstid,delay),resetReceiveTimeout()}catch(err){addReceiveError("Failed to queue burst task: "+extractErrorMessage(err)),updateStat("receive-status","Error"),updateReceiveDisplay()}},validatePushResponse=(response,sentPayload)=>response?void 0===response.receivedtime?"Missing receivedtime in response (got: "+JSON.stringify(response)+")":"number"!=typeof response.receivedtime||response.receivedtime<=0?"Invalid receivedtime: "+response.receivedtime:response.echo?Number(response.echo.senttime)!==sentPayload.senttime?"Echoed senttime ("+response.echo.senttime+") does not match sent value ("+sentPayload.senttime+")":null:"Server did not echo back the payload":"Empty response from server",handlePushBurst=async()=>{const count=getFieldValue("push-burst-count"),delay=getFieldValue("push-burst-delay",0);resetPushStats(),pushStats.expected=count,updateStat("push-status","Sending..."),updateStat("push-count","0 / "+count),updateStat("push-avg","—"),updateStat("push-minmax","—"),updateStat("push-errors","0"),hideRegion("push-error-details"),showRegion("push-results"),showResetButton("push");for(let i=0;i<count;i++){i>0&&delay>0&&await new Promise((resolve=>setTimeout(resolve,delay)));const startTime=Date.now(),payload={senttime:startTime,seq:i,total:count};try{const response=await(0,_api.sendToServer)("tool_realtime",payload,!0),rtt=Date.now()-startTime,validationError=validatePushResponse(response,payload);validationError?(pushStats.errors++,pushStats.errorMessages.push("Event "+i+": "+validationError)):(pushStats.count++,pushStats.totalRtt+=rtt,pushStats.min=Math.min(pushStats.min,rtt),pushStats.max=Math.max(pushStats.max,rtt))}catch(err){pushStats.errors++,pushStats.errorMessages.push("Event "+i+": "+extractErrorMessage(err))}updatePushDisplay()}updateStat("push-status",pushStats.errors>0?"Complete (with errors)":"Complete")},handleReceiveReset=()=>{resetReceiveStats(),hideRegion("receive-results"),hideRegion("receive-error-details");const el=getRoot().querySelector(SELECTORS_action("receive-reset"));el&&el.classList.add("d-none")},handlePushReset=()=>{resetPushStats(),hideRegion("push-results"),hideRegion("push-error-details");const el=getRoot().querySelector(SELECTORS_action("push-reset"));el&&el.classList.add("d-none")};_exports.init=()=>{PubSub.subscribe(_events.default.EVENT,onEventReceived),PubSub.subscribe(_events.default.CONNECTION_LOST,(()=>{receiveStats&&(addReceiveError("Connection lost"),updateStat("receive-status","Connection lost"),updateReceiveDisplay())}));const root=getRoot();if(!root)return;const actions={"receive-single":handleReceiveSingle,"receive-burst":handleReceiveBurst,"receive-reset":handleReceiveReset,"push-burst":handlePushBurst,"push-reset":handlePushReset};root.addEventListener("click",(e=>{const button=e.target.closest("[data-action]");if(!button)return;const action=button.dataset.action;actions[action]&&actions[action]()}))}}));

//# sourceMappingURL=test_settings.min.js.map