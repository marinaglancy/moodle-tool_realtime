{"version":3,"file":"realtime.min.js","sources":["../src/realtime.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Real time events using Pusher\n *\n * @module     realtimeplugin_pusher/realtime\n * @copyright  2020 Daniel Conquit, Matthew Gray, Nicholas Parker, Dan Thistlethwaite\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nrequire.config({\n    paths: {\n        \"pusher\": 'https://js.pusher.com/7.0/pusher'\n    }\n});\n\nimport * as PubSub from 'core/pubsub';\nimport * as RealTimeEvents from 'tool_realtime/events';\n\nlet params;\n\n/**\n * Initialise plugin\n *\n * @param {String} key\n * @param {String} cluster\n */\nexport function init(key, cluster) {\n    params = {\n        key,\n        cluster\n    };\n}\n\n/**\n * Subscribe to events\n *\n * @param {String} hash\n * @param {Number} context\n * @param {String} component\n * @param {String} area\n * @param {Number} itemid\n * @param {String} channel\n */\nexport function subscribe(hash, context, component, area, itemid, channel) {\n    require(['pusher'], function(Pusher) {\n        var pusher = new Pusher(params.key, {\n            cluster: params.cluster\n        });\n\n        var pusherChannel = pusher.subscribe(hash);\n        pusherChannel.bind('event', function(data) {\n            let payload;\n            try {\n                payload = JSON.parse(data);\n            } catch (_) {\n                payload = [];\n            }\n            var dataToSend = {\n                context, component: component, area, itemid, channel, payload\n            };\n            PubSub.publish(RealTimeEvents.EVENT, dataToSend);\n        });\n    });\n}\n"],"names":["params","key","cluster","hash","context","component","area","itemid","channel","require","Pusher","subscribe","bind","data","payload","JSON","parse","_","dataToSend","PubSub","publish","RealTimeEvents","EVENT","config","paths"],"mappings":";;;;;;;SAgCIA,sFAQiBC,IAAKC,SACtBF,OAAS,CACLC,IAAAA,IACAC,QAAAA,sCAckBC,KAAMC,QAASC,UAAWC,KAAMC,OAAQC,SAC9DC,QAAQ,CAAC,WAAW,SAASC,QACZ,IAAIA,OAAOV,OAAOC,IAAK,CAChCC,QAASF,OAAOE,UAGOS,UAAUR,MACvBS,KAAK,SAAS,SAASC,UAC7BC,YAEAA,QAAUC,KAAKC,MAAMH,MACvB,MAAOI,GACLH,QAAU,OAEVI,WAAa,CACbd,QAAAA,QAASC,UAAWA,UAAWC,KAAAA,KAAMC,OAAAA,OAAQC,QAAAA,QAASM,QAAAA,SAE1DK,OAAOC,QAAQC,eAAeC,MAAOJ,iHAnDjDT,QAAQc,OAAO,CACXC,MAAO,QACO"}