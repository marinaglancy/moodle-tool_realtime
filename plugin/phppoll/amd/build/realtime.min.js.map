{"version":3,"file":"realtime.min.js","sources":["../src/realtime.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Real time events\n *\n * @module     realtimeplugin_phppoll/realtime\n * @copyright  2020 Marina Glancy\n */\n\nimport * as PubSub from 'core/pubsub';\nimport * as RealTimeEvents from 'tool_realtime/events';\n\nvar params;\nvar channels = [];\nvar requestscounter = [];\nvar pollURL;\nvar ajax = new XMLHttpRequest();\n\n/**\n * Make sure we don't send requests too often\n *\n * @returns {Boolean}\n */\nfunction checkRequestCounter() {\n    var curDate = new Date(),\n        curTime = curDate.getTime();\n    requestscounter.push(curTime);\n    requestscounter = requestscounter.slice(-10);\n    // If there were 10 requests in less than 5 seconds, it must be an error. Stop polling.\n    if (requestscounter.length >= 10 && curTime - requestscounter[0] < 5000) {\n        PubSub.publish(RealTimeEvents.CONNECTION_LOST);\n        return false;\n    }\n    return true;\n}\n\n/**\n * Polls for events, schedules the next poll\n */\nfunction poll() {\n    if (!checkRequestCounter()) {\n        // Too many requests, stop polling.\n        return;\n    }\n    ajax.onreadystatechange = function() {\n        if (this.readyState === 4 && this.status === 200) {\n            if (this.status === 200) {\n                let json;\n                try {\n                    json = JSON.parse(this.responseText);\n                } catch {\n                    setTimeout(poll, params.timeout);\n                    return;\n                }\n                if (!json.success || json.success !== 1) {\n                    // Poll.php returned an error or an exception. Stop trying to poll.\n                    PubSub.publish(RealTimeEvents.CONNECTION_LOST);\n                    return;\n                }\n\n                // Process results - trigger all necessary Javascript/jQuery events.\n                var events = json.events;\n                for (var i in events) {\n                    PubSub.publish(RealTimeEvents.EVENT, events[i]);\n                    // Remember the last id.\n                    params.fromid = events[i].id;\n                }\n                // And start polling again.\n                setTimeout(poll, params.timeout);\n            } else {\n                // Must be a server timeout or loss of network - start new process.\n                setTimeout(poll, params.timeout);\n            }\n        }\n    };\n\n    if (channels.length <= 0) {\n        return;\n    }\n    let query = 'userid=' + encodeURIComponent(params.userid) +\n        '&token=' + encodeURIComponent(params.token) +\n        '&fromid=' + encodeURIComponent(params.fromid) +\n        '&channels=' + encodeURIComponent(JSON.stringify(channels));\n\n    ajax.open('POST', pollURL, true);\n    ajax.setRequestHeader(\"Content-type\", \"application/x-www-form-urlencoded\");\n    ajax.send(query);\n}\n\n/**\n * Initialise plugin\n *\n * @param {Number} userId\n * @param {String} token\n * @param {String} pollURLParam\n * @param {Number} timeout\n */\nexport function init(userId, token, pollURLParam, timeout) {\n    if (params && params.userid) {\n        // Log console dev error.\n    } else {\n        params = {\n            userid: userId,\n            token: token,\n            timeout: timeout,\n        };\n    }\n    pollURL = pollURLParam;\n}\n\n/**\n * Subscribe to events\n *\n * @param {Number} context\n * @param {String} component\n * @param {String} area\n * @param {Number} itemid\n * @param {String} channel\n * @param {Number} fromId\n * @param {Number} fromtimestamp\n */\nexport function subscribe(context, component, area, itemid, channel, fromId, fromtimestamp) {\n    params.fromid = fromId;\n    var channeltosubto = {\n        context,\n        component,\n        area,\n        itemid,\n        channel,\n        fromtimestamp,\n    };\n    channels.push(channeltosubto);\n    setTimeout(poll, params.timeout);\n}\n"],"names":["params","userId","token","pollURLParam","timeout","userid","pollURL","context","component","area","itemid","channel","fromId","fromtimestamp","fromid","channeltosubto","channels","push","setTimeout","poll","requestscounter","ajax","XMLHttpRequest","curTime","Date","getTime","slice","length","PubSub","publish","RealTimeEvents","CONNECTION_LOST","onreadystatechange","this","readyState","status","json","JSON","parse","responseText","success","events","i","EVENT","id","query","encodeURIComponent","stringify","open","setRequestHeader","send"],"mappings":"+jCAyBIA,sFAqFiBC,OAAQC,MAAOC,aAAcC,SAC1CJ,QAAUA,OAAOK,SAGjBL,OAAS,CACLK,OAAQJ,OACRC,MAAOA,MACPE,QAASA,UAGjBE,QAAUH,0CAcYI,QAASC,UAAWC,KAAMC,OAAQC,QAASC,OAAQC,eACzEb,OAAOc,OAASF,WACZG,eAAiB,CACjBR,QAAAA,QACAC,UAAAA,UACAC,KAAAA,KACAC,OAAAA,OACAC,QAAAA,QACAE,cAAAA,eAEJG,SAASC,KAAKF,gBACdG,WAAWC,KAAMnB,OAAOI,4GArHxBE,QAFAU,SAAW,GACXI,gBAAkB,GAElBC,KAAO,IAAIC,wBAuBNH,UAdDI,SADU,IAAIC,MACIC,UACtBL,gBAAgBH,KAAKM,UACrBH,gBAAkBA,gBAAgBM,OAAO,KAErBC,QAAU,IAAMJ,QAAUH,gBAAgB,GAAK,MAC/DQ,OAAOC,QAAQC,eAAeC,iBACvB,cANPR,WAmBJF,KAAKW,mBAAqB,cACE,IAApBC,KAAKC,YAAoC,MAAhBD,KAAKE,UACV,MAAhBF,KAAKE,OAAgB,KACjBC,SAEAA,KAAOC,KAAKC,MAAML,KAAKM,cACzB,kBACErB,WAAWC,KAAMnB,OAAOI,aAGvBgC,KAAKI,SAA4B,IAAjBJ,KAAKI,oBAEtBZ,OAAOC,QAAQC,eAAeC,qBAK9BU,OAASL,KAAKK,WACb,IAAIC,KAAKD,OACVb,OAAOC,QAAQC,eAAea,MAAOF,OAAOC,IAE5C1C,OAAOc,OAAS2B,OAAOC,GAAGE,GAG9B1B,WAAWC,KAAMnB,OAAOI,cAGxBc,WAAWC,KAAMnB,OAAOI,UAKhCY,SAASW,QAAU,aAGnBkB,MAAQ,UAAYC,mBAAmB9C,OAAOK,QAC9C,UAAYyC,mBAAmB9C,OAAOE,OACtC,WAAa4C,mBAAmB9C,OAAOc,QACvC,aAAegC,mBAAmBT,KAAKU,UAAU/B,WAErDK,KAAK2B,KAAK,OAAQ1C,SAAS,GAC3Be,KAAK4B,iBAAiB,eAAgB,qCACtC5B,KAAK6B,KAAKL"}