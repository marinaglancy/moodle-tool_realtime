{"version":3,"sources":["../src/realtime.js"],"names":["define","PubSub","RealTimeEvents","api","params","channels","requestscounter","pollURL","ajax","XMLHttpRequest","json","checkRequestCounter","curDate","Date","curTime","getTime","push","slice","length","publish","CONNECTION_LOST","poll","onreadystatechange","readyState","status","JSON","parse","responseText","setTimeout","timeout","success","events","i","EVENT","fromid","id","url","encodeURIComponent","userid","token","contextstring","componentstring","areastring","itemidstring","fromtimestampstring","context","component","area","itemid","fromtimestamp","channelstring","open","send","plugin","init","userId","pollURLParam","setImplementation","subscribe","fromId","fromTimeStamp","channeltosubto","console","log"],"mappings":"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","sourcesContent":["/**\n * Real time events\n *\n * @module     realtimeplugin_phppoll/realtime\n * @package    realtimeplugin_phppoll\n * @copyright  2020 Marina Glancy\n */\ndefine(['core/pubsub', 'tool_realtime/events', 'tool_realtime/api'], function(PubSub, RealTimeEvents,api) {\n\n    var params;\n    var channels = [];\n    var requestscounter = [];\n    var pollURL;\n    var ajax = new XMLHttpRequest(), json;\n\n    var checkRequestCounter = function() {\n        var curDate = new Date(),\n            curTime = curDate.getTime();\n        requestscounter.push(curTime);\n        requestscounter = requestscounter.slice(-10);\n        // If there were 10 requests in less than 5 seconds, it must be an error. Stop polling.\n        if (requestscounter.length >= 10 && curTime - requestscounter[0] < 5000) {\n            PubSub.publish(RealTimeEvents.CONNECTION_LOST);\n            return false;\n        }\n        return true;\n    };\n\n    var poll = function() {\n        if (!checkRequestCounter()) {\n            // Too many requests, stop polling.\n            return;\n        }\n        ajax.onreadystatechange = function() {\n            if (this.readyState === 4 && this.status === 200) {\n                if (this.status === 200) {\n                    try {\n                        json = JSON.parse(this.responseText);\n                    } catch {\n                        setTimeout(poll, params.timeout);\n                        return;\n                    }\n                    if (!json.success || json.success !== 1) {\n                        // Poll.php returned an error or an exception. Stop trying to poll.\n                        return;\n                    }\n\n                    // Process results - trigger all necessary Javascript/jQuery events.\n                    var events = json.events;\n                    for (var i in events) {\n                        PubSub.publish(RealTimeEvents.EVENT, events[i]);\n                        // Remember the last id.\n                        params.fromid = events[i].id;\n                    }\n                    // And start polling again.\n                    setTimeout(poll, params.timeout);\n                } else {\n                    // Must be a server timeout or loss of network - start new process.\n                    setTimeout(poll, params.timeout);\n                }\n            }\n        };\n        var url = pollURL + '?userid=' + encodeURIComponent(params.userid) + '&token=' +\n            encodeURIComponent(params.token) + '&fromid=' + encodeURIComponent(params.fromid);\n\n        //'&channel=' + encodeURIComponent(params.context) + ':' +\n        //             encodeURIComponent(params.component) + ':' + encodeURIComponent(params.area) +\n        //             ':' + encodeURIComponent(params.itemid) +\n        //             ':' + encodeURIComponent(params.fromtimestamp);\n\n        if(channels.length <= 0) {\n            return;\n        }\n\n        var contextstring=\"\";\n        var componentstring=\"\";\n        var areastring=\"\";\n        var itemidstring=\"\";\n        var fromtimestampstring=\"\";\n\n        for (var i = 0; i < channels.length; i++) {\n            if (i == channels.length - 1) {\n                contextstring += channels[i].context;\n                componentstring += channels[i].component;\n                areastring += channels[i].area;\n                itemidstring += channels[i].itemid;\n                fromtimestampstring += channels[i].fromtimestamp;\n            } else {\n                contextstring += channels[i].context + '-';\n                componentstring += channels[i].component + '-';\n                areastring += channels[i].area + '-';\n                itemidstring += channels[i].itemid + '-';\n                fromtimestampstring += channels[i].fromtimestamp + '-';\n            }\n        }\n\n        var channelstring = '&channel=' + contextstring + ':'\n                                        + componentstring + ':'\n                                        + areastring + ':'\n                                        + itemidstring + ':'\n                                        + fromtimestampstring;\n\n        url += channelstring;\n\n        ajax.open('GET', url, true);\n        ajax.send();\n    };\n\n    var plugin =  {\n        init: function(userId, token, pollURLParam, timeout) {\n            if (params && params.userid) {\n                // log console dev error\n            } else {\n                params = {\n                    userid: userId,\n                    token: token,\n                    timeout: timeout,\n                };\n            }\n            pollURL = pollURLParam;\n            api.setImplementation(plugin);\n        },\n        subscribe: function(context, component, area, itemid, fromId, fromTimeStamp) {\n            params.fromid = fromId;\n            var channeltosubto = {\n                                    context: context,\n                                    component: component,\n                                    area: area,\n                                    itemid: itemid,\n                                    fromtimestamp: fromTimeStamp,\n                                };\n            if(channeltosubto) {\n                channels.push(channeltosubto);\n            }\n            console.log(channels);\n            setTimeout(poll, params.timeout);\n        }\n    };\n\n\n    return plugin;\n});\n"],"file":"realtime.min.js"}