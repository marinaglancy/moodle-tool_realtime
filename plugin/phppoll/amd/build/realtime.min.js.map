{"version":3,"file":"realtime.min.js","sources":["../src/realtime.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Real time events\n *\n * @module     realtimeplugin_phppoll/realtime\n * @copyright  2020 Marina Glancy\n */\n\nimport * as PubSub from 'core/pubsub';\nimport * as RealTimeEvents from 'tool_realtime/events';\n\nvar params;\nvar channels = [];\nvar requestscounter = [];\nvar pollURL;\nvar ajax = new XMLHttpRequest();\nvar pollTimer = null;\n\n/**\n * Make sure we don't send requests too often\n *\n * @returns {Boolean}\n */\nfunction checkRequestCounter() {\n    var curDate = new Date(),\n        curTime = curDate.getTime();\n    requestscounter.push(curTime);\n    requestscounter = requestscounter.slice(-10);\n    // If there were 10 requests in less than 5 seconds, it must be an error. Stop polling.\n    if (requestscounter.length >= 10 && curTime - requestscounter[0] < 5000) {\n        PubSub.publish(RealTimeEvents.CONNECTION_LOST);\n        return false;\n    }\n    return true;\n}\n\n/**\n * Schedule the next poll if one is not already scheduled or in-flight\n */\nfunction schedulePoll() {\n    if (pollTimer === null) {\n        pollTimer = setTimeout(poll, params.timeout);\n    }\n}\n\n/**\n * Abort any in-flight request and pending timer, then schedule a fresh poll\n */\nfunction restartPoll() {\n    if (pollTimer !== null) {\n        clearTimeout(pollTimer);\n        pollTimer = null;\n    }\n    // Abort in-flight request so it doesn't reschedule on completion.\n    if (ajax.readyState !== 0 && ajax.readyState !== 4) {\n        ajax.abort();\n    }\n    schedulePoll();\n}\n\n/**\n * Polls for events, schedules the next poll\n */\nfunction poll() {\n    pollTimer = null;\n    if (!checkRequestCounter()) {\n        // Too many requests, stop polling.\n        return;\n    }\n\n    if (channels.length <= 0) {\n        return;\n    }\n\n    ajax.onreadystatechange = function() {\n        if (this.readyState !== 4) {\n            return;\n        }\n        // Status 0 means the request was aborted - don't reschedule, the caller handles it.\n        if (this.status === 0) {\n            return;\n        }\n        if (this.status === 200) {\n            let json;\n            try {\n                json = JSON.parse(this.responseText);\n            } catch {\n                schedulePoll();\n                return;\n            }\n            if (!json.success || json.success !== 1) {\n                // Poll.php returned an error or an exception. Stop trying to poll.\n                PubSub.publish(RealTimeEvents.CONNECTION_LOST);\n                return;\n            }\n\n            // Process results - trigger all necessary Javascript/jQuery events.\n            var events = json.events;\n            for (var i in events) {\n                PubSub.publish(RealTimeEvents.EVENT, events[i]);\n                // Remember the last id.\n                params.fromid = events[i].id;\n            }\n        }\n        // Schedule next poll for both successful and failed (non-abort) responses.\n        schedulePoll();\n    };\n\n    let query = 'userid=' + encodeURIComponent(params.userid) +\n        '&fromid=' + encodeURIComponent(params.fromid) +\n        '&sid=' + encodeURIComponent(params.sid);\n    for (let i = 0; i < channels.length; i++) {\n        query += `&channels[${i}]=` + encodeURIComponent(channels[i].hash);\n        query += `&key[${i}]=` + encodeURIComponent(channels[i].key);\n    }\n\n    ajax.open('POST', pollURL, true);\n    ajax.setRequestHeader(\"Content-type\", \"application/x-www-form-urlencoded\");\n    ajax.send(query);\n}\n\n/**\n * Initialise plugin\n *\n * @param {Number} userId\n * @param {String} pollURLParam\n * @param {Number} timeout\n * @param {String} sid\n */\nexport function init(userId, pollURLParam, timeout, sid) {\n    if (params && params.userid) {\n        // Log console dev error.\n    } else {\n        params = {\n            userid: userId,\n            timeout: timeout,\n            sid\n        };\n    }\n    pollURL = pollURLParam;\n}\n\n/**\n * Subscribe to events\n *\n * @param {String} hash\n * @param {String} key\n * @param {Number} fromId\n */\nexport function subscribe(hash, key, fromId) {\n    params.fromid = fromId;\n    channels.push({hash, key});\n    restartPoll();\n}\n"],"names":["params","userId","pollURLParam","timeout","sid","userid","pollURL","hash","key","fromId","fromid","channels","push","pollTimer","clearTimeout","ajax","readyState","abort","schedulePoll","restartPoll","requestscounter","XMLHttpRequest","setTimeout","poll","curTime","Date","getTime","slice","length","PubSub","publish","RealTimeEvents","CONNECTION_LOST","onreadystatechange","this","status","json","JSON","parse","responseText","success","events","i","EVENT","id","query","encodeURIComponent","open","setRequestHeader","send"],"mappings":"+jCAyBIA,sFAsHiBC,OAAQC,aAAcC,QAASC,KAC5CJ,QAAUA,OAAOK,SAGjBL,OAAS,CACLK,OAAQJ,OACRE,QAASA,QACTC,IAAAA,MAGRE,QAAUJ,0CAUYK,KAAMC,IAAKC,QACjCT,OAAOU,OAASD,OAChBE,SAASC,KAAK,CAACL,KAAAA,KAAMC,IAAAA,iBAtGH,OAAdK,YACAC,aAAaD,WACbA,UAAY,MAGQ,IAApBE,KAAKC,YAAwC,IAApBD,KAAKC,YAC9BD,KAAKE,QAETC,eA+FAC,sGA1IAb,QAFAK,SAAW,GACXS,gBAAkB,GAElBL,KAAO,IAAIM,eACXR,UAAY,cAuBPK,eACa,OAAdL,YACAA,UAAYS,WAAWC,KAAMvB,OAAOG,mBAsBnCoB,UACLV,UAAY,KAvCRW,SADU,IAAIC,MACIC,UACtBN,gBAAgBR,KAAKY,UACrBJ,gBAAkBA,gBAAgBO,OAAO,KAErBC,QAAU,IAAMJ,QAAUJ,gBAAgB,GAAK,MAC/DS,OAAOC,QAAQC,eAAeC,iBACvB,cANPR,WA6CAb,SAASiB,QAAU,SAIvBb,KAAKkB,mBAAqB,cACE,IAApBC,KAAKlB,YAIW,IAAhBkB,KAAKC,WAGW,MAAhBD,KAAKC,OAAgB,KACjBC,SAEAA,KAAOC,KAAKC,MAAMJ,KAAKK,cACzB,kBACErB,mBAGCkB,KAAKI,SAA4B,IAAjBJ,KAAKI,oBAEtBX,OAAOC,QAAQC,eAAeC,qBAK9BS,OAASL,KAAKK,WACb,IAAIC,KAAKD,OACVZ,OAAOC,QAAQC,eAAeY,MAAOF,OAAOC,IAE5C1C,OAAOU,OAAS+B,OAAOC,GAAGE,GAIlC1B,qBAGA2B,MAAQ,UAAYC,mBAAmB9C,OAAOK,QAC9C,WAAayC,mBAAmB9C,OAAOU,QACvC,QAAUoC,mBAAmB9C,OAAOI,SACnC,IAAIsC,EAAI,EAAGA,EAAI/B,SAASiB,OAAQc,IACjCG,OAAS,oBAAaH,QAAQI,mBAAmBnC,SAAS+B,GAAGnC,MAC7DsC,OAAS,eAAQH,QAAQI,mBAAmBnC,SAAS+B,GAAGlC,KAG5DO,KAAKgC,KAAK,OAAQzC,SAAS,GAC3BS,KAAKiC,iBAAiB,eAAgB,qCACtCjC,KAAKkC,KAAKJ"}