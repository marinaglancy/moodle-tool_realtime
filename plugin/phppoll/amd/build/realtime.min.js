define("realtimeplugin_phppoll/realtime",["exports","core/pubsub","tool_realtime/events"],(function(_exports,PubSub,RealTimeEvents){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}var params;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=function(userId,pollURLParam,timeout,sid){params&&params.userid||(params={userid:userId,timeout:timeout,sid:sid});pollURL=pollURLParam},_exports.subscribe=function(hash,key,fromId){params.fromid=fromId,channels.push({hash:hash,key:key}),function(){null!==pollTimer&&(clearTimeout(pollTimer),pollTimer=null);0!==ajax.readyState&&4!==ajax.readyState&&ajax.abort();schedulePoll()}()},PubSub=_interopRequireWildcard(PubSub),RealTimeEvents=_interopRequireWildcard(RealTimeEvents);var pollURL,channels=[],requestscounter=[],ajax=new XMLHttpRequest,pollTimer=null;function schedulePoll(){null===pollTimer&&(pollTimer=setTimeout(poll,params.timeout))}function poll(){if(pollTimer=null,curTime=(new Date).getTime(),requestscounter.push(curTime),(requestscounter=requestscounter.slice(-10)).length>=10&&curTime-requestscounter[0]<5e3&&(PubSub.publish(RealTimeEvents.CONNECTION_LOST),1))return;var curTime;if(channels.length<=0)return;ajax.onreadystatechange=function(){if(4===this.readyState&&0!==this.status){if(200===this.status){let json;try{json=JSON.parse(this.responseText)}catch{return void schedulePoll()}if(!json.success||1!==json.success)return void PubSub.publish(RealTimeEvents.CONNECTION_LOST);var events=json.events;for(var i in events)PubSub.publish(RealTimeEvents.EVENT,events[i]),params.fromid=events[i].id}schedulePoll()}};let query="userid="+encodeURIComponent(params.userid)+"&fromid="+encodeURIComponent(params.fromid)+"&sid="+encodeURIComponent(params.sid);for(let i=0;i<channels.length;i++)query+="&channels[".concat(i,"]=")+encodeURIComponent(channels[i].hash),query+="&key[".concat(i,"]=")+encodeURIComponent(channels[i].key);ajax.open("POST",pollURL,!0),ajax.setRequestHeader("Content-type","application/x-www-form-urlencoded"),ajax.send(query)}}));

//# sourceMappingURL=realtime.min.js.map