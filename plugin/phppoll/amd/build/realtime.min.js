define("realtimeplugin_phppoll/realtime",["core/pubsub","tool_realtime/events","tool_realtime/api"],(function(PubSub,RealTimeEvents,api){var params,pollURL,json,channels=[],requestscounter=[],ajax=new XMLHttpRequest,poll=function(){if(curTime=(new Date).getTime(),requestscounter.push(curTime),!((requestscounter=requestscounter.slice(-10)).length>=10&&curTime-requestscounter[0]<5e3&&(PubSub.publish(RealTimeEvents.CONNECTION_LOST),1))){var curTime;ajax.onreadystatechange=function(){if(4===this.readyState&&200===this.status)if(200===this.status){try{json=JSON.parse(this.responseText)}catch{return void setTimeout(poll,params.timeout)}if(!json.success||1!==json.success)return;var events=json.events;for(var i in events)PubSub.publish(RealTimeEvents.EVENT,events[i]),params.fromid=events[i].id;setTimeout(poll,params.timeout)}else setTimeout(poll,params.timeout)};var url=pollURL+"?userid="+encodeURIComponent(params.userid)+"&token="+encodeURIComponent(params.token)+"&fromid="+encodeURIComponent(params.fromid);if(!(channels.length<=0)){for(var contextstring="",componentstring="",areastring="",itemidstring="",fromtimestampstring="",i=0;i<channels.length;i++)i==channels.length-1?(contextstring+=channels[i].context,componentstring+=channels[i].component,areastring+=channels[i].area,itemidstring+=channels[i].itemid,fromtimestampstring+=channels[i].fromtimestamp):(contextstring+=channels[i].context+"-",componentstring+=channels[i].component+"-",areastring+=channels[i].area+"-",itemidstring+=channels[i].itemid+"-",fromtimestampstring+=channels[i].fromtimestamp+"-");url+="&channel="+contextstring+":"+componentstring+":"+areastring+":"+itemidstring+":"+fromtimestampstring,ajax.open("GET",url,!0),ajax.send()}}},plugin={init:function(userId,token,pollURLParam,timeout){params&&params.userid||(params={userid:userId,token:token,timeout:timeout}),pollURL=pollURLParam,api.setImplementation(plugin)},subscribe:function(context,component,area,itemid,fromId,fromTimeStamp){params.fromid=fromId;var channeltosubto={context:context,component:component,area:area,itemid:itemid,fromtimestamp:fromTimeStamp};channeltosubto&&channels.push(channeltosubto),console.log("Subscribe to",channels),setTimeout(poll,params.timeout)}};return plugin}));

//# sourceMappingURL=realtime.min.js.map