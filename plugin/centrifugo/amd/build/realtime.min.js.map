{"version":3,"file":"realtime.min.js","sources":["../src/realtime.js"],"sourcesContent":["// This file is part of realtimeplugin_centrifugo plugin\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Real time events using Centrifugo\n *\n * @module     realtimeplugin_centrifugo/realtime\n * @copyright  2025 Marina Glancy\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as PubSub from 'core/pubsub';\nimport * as RealTimeEvents from 'tool_realtime/events';\nimport * as Ajax from 'core/ajax';\nimport * as api from 'tool_realtime/api';\nimport * as config from 'core/config';\nimport {Centrifuge, UnauthorizedError} from './centrifuge-lazy';\n\nlet params;\nlet centrifuge;\n\nconst sendToServer = (component, payload) => {\n    return centrifuge.rpc('user.event', {component, sesskey: config.sesskey, payload})\n        .then((response) => response.data);\n};\n\n/**\n * Initialise plugin\n *\n * @param {Array} initParams\n */\nexport function init(initParams) {\n    params = initParams;\n    centrifuge = new Centrifuge(params.host, {token: params.token, getToken: getToken});\n    if (params.userpc) {\n        api.setImplementation({sendToServer});\n    }\n}\n\nconst getToken = async() => {\n    try {\n        const response = await Ajax.call([{\n            methodname: 'realtimeplugin_centrifugo_get_token',\n            args: {},\n        }])[0];\n        params.token = response?.token;\n    } catch (error) {\n        params.token = null;\n    }\n    if (!params.token) {\n        throw new UnauthorizedError();\n    }\n    return params.token;\n};\n\n/**\n * Subscribe to events\n *\n * @param {String} hash\n * @param {Object} properties\n */\nexport function subscribe(hash, properties) {\n\n    centrifuge.on('disconnected', function() {\n        PubSub.publish(RealTimeEvents.CONNECTION_LOST);\n    });\n\n    // Allocate Subscription to a channel.\n    const sub = centrifuge.newSubscription(hash);\n\n    // React on channel real-time publications.\n    sub.on('publication', async(ctx) => {\n        const payload = ctx.data.payload;\n        var dataToSend = {...properties, payload};\n        PubSub.publish(RealTimeEvents.EVENT, dataToSend);\n    });\n\n    // Trigger subscribe process.\n    sub.subscribe();\n\n    // Trigger actual connection establishement.\n    centrifuge.connect();\n}\n"],"names":["params","centrifuge","initParams","Centrifuge","host","token","getToken","userpc","api","setImplementation","sendToServer","hash","properties","on","PubSub","publish","RealTimeEvents","CONNECTION_LOST","sub","newSubscription","async","payload","ctx","data","dataToSend","EVENT","subscribe","connect","component","rpc","sesskey","config","then","response","Ajax","call","methodname","args","error","UnauthorizedError"],"mappings":";;;;;;;SA8BIA,OACAC,0FAYiBC,YACjBF,OAASE,WACTD,WAAa,IAAIE,2BAAWH,OAAOI,KAAM,CAACC,MAAOL,OAAOK,MAAOC,SAAUA,WACrEN,OAAOO,QACPC,IAAIC,kBAAkB,CAACC,aAAAA,4CA0BLC,KAAMC,YAE5BX,WAAWY,GAAG,gBAAgB,WAC1BC,OAAOC,QAAQC,eAAeC,0BAI5BC,IAAMjB,WAAWkB,gBAAgBR,MAGvCO,IAAIL,GAAG,eAAeO,MAAAA,YACZC,QAAUC,IAAIC,KAAKF,YACrBG,WAAa,IAAIZ,WAAYS,QAAAA,SACjCP,OAAOC,QAAQC,eAAeS,MAAOD,eAIzCN,IAAIQ,YAGJzB,WAAW0B,0NA5DTjB,aAAe,CAACkB,UAAWP,UACtBpB,WAAW4B,IAAI,aAAc,CAACD,UAAAA,UAAWE,QAASC,OAAOD,QAAST,QAAAA,UACpEW,MAAMC,UAAaA,SAASV,aAgB/BjB,SAAWc,oBAEHa,eAAiBC,KAAKC,KAAK,CAAC,CAC9BC,WAAY,sCACZC,KAAM,MACN,GACJrC,OAAOK,MAAQ4B,MAAAA,gBAAAA,SAAU5B,MAC3B,MAAOiC,OACLtC,OAAOK,MAAQ,SAEdL,OAAOK,YACF,IAAIkC,yCAEPvC,OAAOK"}