{"version":3,"file":"import_settings.min.js","sources":["../src/import_settings.js"],"sourcesContent":["// This file is part of realtimeplugin_centrifugo plugin\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Import settings from Centrifugo configuration or Railway template variables.\n *\n * @module     realtimeplugin_centrifugo/import_settings\n * @copyright  2026 Marina Glancy\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ModalSaveCancel from 'core/modal_save_cancel';\nimport ModalEvents from 'core/modal_events';\nimport {getString} from 'core/str';\n\nconst COMPONENT = 'realtimeplugin_centrifugo';\nconst SETTINGS_PREFIX = 'id_s_realtimeplugin_centrifugo_';\n\n/**\n * Parse Centrifugo native JSON configuration.\n *\n * @param {Object} data Parsed JSON object\n * @returns {Object} Extracted settings\n */\nconst parseCentrifugoConfig = (data) => {\n    const result = {\n        apikey: data?.http_api?.key || '',\n        tokensecret: data?.client?.token?.hmac_secret_key || '',\n        webhookkey: '',\n    };\n\n    if (Array.isArray(data?.proxies)) {\n        let fallbackKey = '';\n        for (const proxy of data.proxies) {\n            const headers = proxy?.http?.static_headers || {};\n            const headerEntry = Object.entries(headers).find(([k]) => k.toLowerCase() === 'x-moodle-key');\n            const key = headerEntry ? headerEntry[1] : '';\n            if (key) {\n                fallbackKey = key;\n                if (proxy.endpoint && proxy.endpoint.includes('webhook-rpc.php')) {\n                    result.webhookkey = key;\n                    break;\n                }\n            }\n        }\n        if (!result.webhookkey) {\n            result.webhookkey = fallbackKey;\n        }\n    }\n\n    return result;\n};\n\n/**\n * Parse Railway template variables (flat key-value JSON).\n *\n * @param {Object} data Parsed JSON object\n * @returns {Object} Extracted settings\n */\nconst parseRailwayJson = (data) => ({\n    apikey: data.CENTRIFUGO_HTTP_API_KEY || '',\n    tokensecret: data.CENTRIFUGO_CLIENT_TOKEN_HMAC_SECRET_KEY || '',\n    webhookkey: data.MOODLE_WEBHOOK_KEY || '',\n    host: data.HOST || '',\n});\n\n/**\n * Parse Railway .env format (KEY=\"VALUE\" lines).\n *\n * @param {string} text Raw .env content\n * @returns {Object} Extracted settings\n */\nconst parseEnvFormat = (text) => {\n    const vars = {};\n    for (const line of text.split('\\n')) {\n        const match = line.match(/^([A-Z_][A-Z0-9_]*)=\"?(.*?)\"?\\s*$/);\n        if (match) {\n            vars[match[1]] = match[2];\n        }\n    }\n    return {\n        apikey: vars.CENTRIFUGO_HTTP_API_KEY || '',\n        tokensecret: vars.CENTRIFUGO_CLIENT_TOKEN_HMAC_SECRET_KEY || '',\n        webhookkey: vars.MOODLE_WEBHOOK_KEY || '',\n    };\n};\n\n/**\n * Parse input text and extract settings.\n *\n * @param {string} text Raw input from textarea\n * @returns {Object|null} Extracted settings or null on failure\n */\nconst parseInput = (text) => {\n    text = text.trim();\n    if (!text) {\n        return null;\n    }\n\n    // Try JSON first.\n    if (text.startsWith('{')) {\n        let data;\n        try {\n            data = JSON.parse(text);\n        } catch (e) {\n            return null;\n        }\n        let result;\n        // Detect Railway JSON format by presence of flat CENTRIFUGO_ keys.\n        if (data.CENTRIFUGO_HTTP_API_KEY !== undefined || data.CENTRIFUGO_CLIENT_TOKEN_HMAC_SECRET_KEY !== undefined) {\n            result = parseRailwayJson(data);\n        } else {\n            // Otherwise treat as native Centrifugo config.\n            result = parseCentrifugoConfig(data);\n        }\n        if (!result.apikey && !result.tokensecret && !result.webhookkey && !result.host) {\n            return null;\n        }\n        return result;\n    }\n\n    // Try .env format.\n    const result = parseEnvFormat(text);\n    if (!result.apikey && !result.tokensecret && !result.webhookkey) {\n        return null;\n    }\n    return result;\n};\n\n/**\n * Set value on a password unmask or regular input field.\n *\n * @param {string} settingName Setting name (e.g. 'apikey')\n * @param {string} value Value to set\n */\nconst setFieldValue = (settingName, value) => {\n    const input = document.getElementById(SETTINGS_PREFIX + settingName);\n    if (!input || !value) {\n        return;\n    }\n    input.value = value;\n\n    // For password unmask widgets, update the dot display.\n    const wrapper = input.closest('[data-passwordunmask=\"wrapper\"]');\n    if (wrapper) {\n        // Click the edit link to enter edit mode, which makes the input visible with the new value.\n        const editLink = wrapper.querySelector('a[data-passwordunmask=\"edit\"]');\n        if (editLink) {\n            editLink.click();\n        }\n    }\n};\n\n/**\n * Initialise the import button.\n */\nexport const init = async() => {\n    const btn = document.getElementById('realtimeplugin_centrifugo_importbtn');\n    if (!btn) {\n        return;\n    }\n\n    const errorMsg = await getString('importerror', COMPONENT);\n\n    const modal = await ModalSaveCancel.create({\n        title: getString('importtitle', COMPONENT),\n        body: getString('importbody', COMPONENT).then((desc) =>\n            '<p>' + desc + '</p>' +\n            '<textarea id=\"centrifugo-import-textarea\" class=\"form-control\" rows=\"10\"></textarea>' +\n            '<div id=\"centrifugo-import-error\" class=\"text-danger mt-2\" style=\"display:none;\"></div>'\n        ),\n        buttons: {\n            save: getString('importbutton', COMPONENT),\n        },\n        removeOnClose: false,\n    });\n\n    modal.getRoot().on(ModalEvents.save, (e) => {\n        e.preventDefault();\n\n        const textarea = document.getElementById('centrifugo-import-textarea');\n        const result = parseInput(textarea ? textarea.value : '');\n\n        const errorEl = document.getElementById('centrifugo-import-error');\n        if (!result) {\n            if (errorEl) {\n                errorEl.textContent = errorMsg;\n                errorEl.style.display = '';\n            }\n            return;\n        }\n        if (errorEl) {\n            errorEl.style.display = 'none';\n        }\n\n        setFieldValue('apikey', result.apikey);\n        setFieldValue('tokensecret', result.tokensecret);\n        setFieldValue('webhookkey', result.webhookkey);\n        setFieldValue('host', result.host);\n        modal.hide();\n    });\n\n    btn.addEventListener('click', () => {\n        // Clear previous state each time the modal is opened.\n        const textarea = document.getElementById('centrifugo-import-textarea');\n        if (textarea) {\n            textarea.value = '';\n        }\n        const errorEl = document.getElementById('centrifugo-import-error');\n        if (errorEl) {\n            errorEl.style.display = 'none';\n        }\n        modal.show();\n    });\n};\n"],"names":["COMPONENT","parseInput","text","trim","startsWith","data","result","JSON","parse","e","undefined","CENTRIFUGO_HTTP_API_KEY","CENTRIFUGO_CLIENT_TOKEN_HMAC_SECRET_KEY","apikey","tokensecret","webhookkey","MOODLE_WEBHOOK_KEY","host","HOST","parseRailwayJson","http_api","key","client","token","hmac_secret_key","Array","isArray","proxies","fallbackKey","proxy","headers","http","static_headers","headerEntry","Object","entries","find","_ref","k","toLowerCase","endpoint","includes","parseCentrifugoConfig","vars","line","split","match","parseEnvFormat","setFieldValue","settingName","value","input","document","getElementById","wrapper","closest","editLink","querySelector","click","async","btn","errorMsg","modal","ModalSaveCancel","create","title","body","then","desc","buttons","save","removeOnClose","getRoot","on","ModalEvents","preventDefault","textarea","errorEl","style","display","hide","textContent","addEventListener","show"],"mappings":"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"}