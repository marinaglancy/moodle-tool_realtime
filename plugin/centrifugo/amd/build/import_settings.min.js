define("realtimeplugin_centrifugo/import_settings",["exports","core/modal_save_cancel","core/modal_events","core/str"],(function(_exports,_modal_save_cancel,_modal_events,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Import settings from Centrifugo configuration or Railway template variables.
   *
   * @module     realtimeplugin_centrifugo/import_settings
   * @copyright  2026 Marina Glancy
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_modal_save_cancel=_interopRequireDefault(_modal_save_cancel),_modal_events=_interopRequireDefault(_modal_events);const COMPONENT="realtimeplugin_centrifugo",parseInput=text=>{if(!(text=text.trim()))return null;if(text.startsWith("{")){let data,result;try{data=JSON.parse(text)}catch(e){return null}return result=void 0!==data.CENTRIFUGO_HTTP_API_KEY||void 0!==data.CENTRIFUGO_CLIENT_TOKEN_HMAC_SECRET_KEY?(data=>({apikey:data.CENTRIFUGO_HTTP_API_KEY||"",tokensecret:data.CENTRIFUGO_CLIENT_TOKEN_HMAC_SECRET_KEY||"",webhookkey:data.MOODLE_WEBHOOK_KEY||""}))(data):(data=>{var _data$http_api,_data$client,_data$client$token;const result={apikey:(null==data||null===(_data$http_api=data.http_api)||void 0===_data$http_api?void 0:_data$http_api.key)||"",tokensecret:(null==data||null===(_data$client=data.client)||void 0===_data$client||null===(_data$client$token=_data$client.token)||void 0===_data$client$token?void 0:_data$client$token.hmac_secret_key)||"",webhookkey:""};if(Array.isArray(null==data?void 0:data.proxies)){let fallbackKey="";for(const proxy of data.proxies){var _proxy$http;const headers=(null==proxy||null===(_proxy$http=proxy.http)||void 0===_proxy$http?void 0:_proxy$http.static_headers)||{},headerEntry=Object.entries(headers).find((_ref=>{let[k]=_ref;return"x-moodle-key"===k.toLowerCase()})),key=headerEntry?headerEntry[1]:"";if(key&&(fallbackKey=key,proxy.endpoint&&proxy.endpoint.includes("webhook-rpc.php"))){result.webhookkey=key;break}}result.webhookkey||(result.webhookkey=fallbackKey)}return result})(data),result.apikey||result.tokensecret||result.webhookkey?result:null}const result=(text=>{const vars={};for(const line of text.split("\n")){const match=line.match(/^([A-Z_][A-Z0-9_]*)="?(.*?)"?\s*$/);match&&(vars[match[1]]=match[2])}return{apikey:vars.CENTRIFUGO_HTTP_API_KEY||"",tokensecret:vars.CENTRIFUGO_CLIENT_TOKEN_HMAC_SECRET_KEY||"",webhookkey:vars.MOODLE_WEBHOOK_KEY||""}})(text);return result.apikey||result.tokensecret||result.webhookkey?result:null},setFieldValue=(settingName,value)=>{const input=document.getElementById("id_s_realtimeplugin_centrifugo_"+settingName);if(!input||!value)return;input.value=value;const wrapper=input.closest('[data-passwordunmask="wrapper"]');if(wrapper){const editLink=wrapper.querySelector('a[data-passwordunmask="edit"]');editLink&&editLink.click()}};_exports.init=async()=>{const btn=document.getElementById("realtimeplugin_centrifugo_importbtn");if(!btn)return;const errorMsg=await(0,_str.getString)("importerror",COMPONENT),modal=await _modal_save_cancel.default.create({title:(0,_str.getString)("importtitle",COMPONENT),body:(0,_str.getString)("importbody",COMPONENT).then((desc=>"<p>"+desc+'</p><textarea id="centrifugo-import-textarea" class="form-control" rows="10"></textarea><div id="centrifugo-import-error" class="text-danger mt-2" style="display:none;"></div>')),buttons:{save:(0,_str.getString)("importbutton",COMPONENT)},removeOnClose:!1});modal.getRoot().on(_modal_events.default.save,(e=>{e.preventDefault();const textarea=document.getElementById("centrifugo-import-textarea"),result=parseInput(textarea?textarea.value:""),errorEl=document.getElementById("centrifugo-import-error");result?(errorEl&&(errorEl.style.display="none"),setFieldValue("apikey",result.apikey),setFieldValue("tokensecret",result.tokensecret),setFieldValue("webhookkey",result.webhookkey),modal.hide()):errorEl&&(errorEl.textContent=errorMsg,errorEl.style.display="")})),btn.addEventListener("click",(()=>{const textarea=document.getElementById("centrifugo-import-textarea");textarea&&(textarea.value="");const errorEl=document.getElementById("centrifugo-import-error");errorEl&&(errorEl.style.display="none"),modal.show()}))}}));

//# sourceMappingURL=import_settings.min.js.map